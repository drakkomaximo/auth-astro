---
import AuthLayout from "../layouts/AuthLayout.astro";

const email = Astro.cookies.get("email")?.value ?? "";
const remember_me = !!email;
---

<AuthLayout title="Login">
    <div class="mb-4">
        <h3 class="font-semibold text-2xl text-gray-800">Sign In</h3>
        <p class="text-gray-500">Please sign in to your account.</p>
    </div>
    <form class="space-y-5">
        <div class="space-y-2">
            <label
                class="text-sm font-medium text-gray-700 tracking-wide"
                for="email"
            >
                Email
            </label>
            <input
                id="email"
                name="email"
                class="w-full text-base px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-400"
                type="email"
                value={email}
                placeholder="mail@gmail.com"
                required
            />
        </div>
        <div class="space-y-2">
            <label
                class="mb-5 text-sm font-medium text-gray-700 tracking-wide"
                for="password"
            >
                Password
            </label>
            <input
                id="password"
                name="password"
                class="w-full content-center text-base px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-400"
                type="password"
                placeholder="Enter your password"
                required
            />
        </div>
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <input
                    id="remember_me"
                    name="remember_me"
                    type="checkbox"
                    class="h-4 w-4 bg-blue-500 focus:ring-blue-400 border-gray-300 rounded"
                    checked={remember_me}
                />
                <label
                    for="remember_me"
                    class="ml-2 block text-sm text-gray-800"
                >
                    Remember me
                </label>
            </div>
            <div class="text-sm">
                <a
                    href="/forgot-password"
                    class="text-green-400 hover:text-green-500"
                >
                    Forgot your password?
                </a>
            </div>
        </div>
        <div>
            <button
                id="btn-submit"
                type="submit"
                class="disabled:opacity-50 disabled:cursor-not-allowed w-full flex justify-center bg-green-400 hover:bg-green-500 text-gray-100 p-3 rounded-full tracking-wide font-semibold shadow-lg cursor-pointer transition ease-in duration-500"
            >
                Sign in
            </button>

            <div class="flex flex-1 w-full justify-center">
                <div class="w-1/2 h-1 bg-gray-300"></div>
            </div>

            <button
                id="btn-google"
                type="button"
                class="w-full flex justify-center bg-red-400 hover:bg-red-500 text-gray-100 p-3 rounded-full tracking-wide font-semibold shadow-lg cursor-pointer transition ease-in duration-500"
            >
                Sign in with Google
            </button>
        </div>
    </form>
    <div class="pt-5 text-center text-gray-400 text-xs">
        <span>
            Don't have an account?
            <a href="/register" class="text-green-400 hover:text-green-500">
                Sign up here
            </a>
        </span>
    </div>
</AuthLayout>

<script>
    import { actions } from "astro:actions";
    import Swal from "sweetalert2";
    import { GoogleAuthProvider, signInWithPopup } from "firebase/auth";
    import { firebase } from "@/firebase/config";

    const form = document.querySelector("form") as HTMLFormElement;
    const btnSubmit = document.querySelector(
        "#btn-submit",
    ) as HTMLButtonElement;
    const btnGoogle = document.querySelector(
        "#btn-google",
    ) as HTMLButtonElement;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        btnSubmit.setAttribute("disabled", "disabled");

        const formData = new FormData(form);

        const { error } = await actions.loginUser(formData);

        if (error) {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: error.message,
            });
            btnSubmit.removeAttribute("disabled");
            return;
        }

        window.location.replace("/protected");
    });

    btnGoogle.addEventListener("click", async () => {
        console.log("click");
        btnSubmit.setAttribute("disabled", "disabled");
        btnGoogle.setAttribute("disabled", "disabled");
        const provider = new GoogleAuthProvider();

        try {
            const credentials = await signInWithPopup(firebase.auth, provider);
            const { error } = await actions.loginWithGoogle(credentials);

            if (error) {
                alert(error.message);
                btnSubmit.removeAttribute("disabled");
                return;
            }

            btnGoogle.innerText = "Redirecting...";
            window.location.replace("/protected");
        } catch (error) {
            console.log(error);
            btnSubmit.removeAttribute("disabled");
            btnGoogle.removeAttribute("disabled");
        }
    });
</script>
